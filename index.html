<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HairHaus Pro | Tha DollHouse</title>

<style>
:root{
  --bg:#000;
  --panel:#0f0f0f;
  --panel2:#121212;
  --text:#fff;
  --muted:#bdbdbd;
  --gold:#C9A24D;
  --danger:#ff5a5a;
  --ok:#6dff9a;
  --shadow: 0 14px 40px rgba(0,0,0,.55);
  --radius: 16px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: radial-gradient(1200px 500px at 50% -5%, rgba(201,162,77,.14), transparent 55%),
              radial-gradient(900px 450px at 10% 10%, rgba(255,255,255,.05), transparent 50%),
              var(--bg);
  color:var(--text);
}
a{color:inherit}
button{
  border:0;
  cursor:pointer;
  border-radius:12px;
  padding:12px 14px;
  font-weight:700;
  color:#000;
  background:var(--gold);
}
button.ghost{
  background:transparent;
  color:var(--text);
  border:1px solid rgba(255,255,255,.16);
}
button.dark{
  background:#1b1b1b;
  color:var(--text);
  border:1px solid rgba(255,255,255,.16);
}
button.danger{
  background:transparent;
  color:var(--danger);
  border:1px solid rgba(255,90,90,.35);
}
input, select, textarea{
  width:100%;
  padding:12px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:#0b0b0b;
  color:var(--text);
  outline:none;
}
textarea{min-height:90px; resize:vertical}
small{color:var(--muted)}
hr{border:0;border-top:1px solid rgba(255,255,255,.10); margin:16px 0}
.container{
  max-width:1100px;
  margin:0 auto;
  padding:20px 14px 90px;
}
.topbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px 14px;
  border:1px solid rgba(255,255,255,.12);
  border-radius:var(--radius);
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  box-shadow:var(--shadow);
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
}
.brandMark{
  width:40px; height:40px;
  border-radius:14px;
  background: radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
              linear-gradient(135deg, rgba(201,162,77,1), rgba(201,162,77,.25));
  border:1px solid rgba(255,255,255,.18);
}
.brandName{font-weight:900; letter-spacing:.3px}
.badge{
  display:inline-flex; align-items:center; gap:8px;
  padding:7px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.35);
  color: var(--muted);
  font-weight:700;
  font-size:12px;
}
.dot{width:8px;height:8px;border-radius:999px;background:var(--gold)}
.dot.ok{background:var(--ok)}
.dot.danger{background:var(--danger)}
.grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:14px;
  margin-top:14px;
}
@media (min-width: 960px){
  .grid{grid-template-columns: 360px 1fr;}
}
.card{
  border-radius:var(--radius);
  border:1px solid rgba(255,255,255,.12);
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  box-shadow:var(--shadow);
  padding:14px;
}
.cardTitle{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
.h1{font-size:22px; font-weight:900; margin:0}
.h2{font-size:16px; font-weight:900; margin:0}
.kpis{
  display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-top:10px;
}
@media(min-width:560px){ .kpis{grid-template-columns: repeat(4, 1fr);} }
.kpi{
  padding:12px;
  border-radius:14px;
  background: rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
}
.kpi .n{font-size:18px; font-weight:900; color:var(--gold)}
.kpi .l{font-size:12px; color:var(--muted); margin-top:2px}
.tabs{
  display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;
}
.tab{
  padding:10px 12px;
  border-radius:999px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  font-weight:800;
}
.tab.active{ background: rgba(201,162,77,.18); border-color: rgba(201,162,77,.40); }
.row{display:flex; gap:10px; flex-wrap:wrap}
.row > *{flex:1}
.list{
  display:flex; flex-direction:column; gap:10px; margin-top:10px;
}
.item{
  padding:12px;
  border-radius:14px;
  background: rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
}
.itemTop{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
.itemTitle{font-weight:900}
.itemMeta{color:var(--muted); font-size:12px; margin-top:4px}
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  font-size:12px;
  font-weight:800;
}
.pill.gold{border-color: rgba(201,162,77,.45); background: rgba(201,162,77,.10)}
.pill.ok{border-color: rgba(109,255,154,.35); background: rgba(109,255,154,.08)}
.pill.danger{border-color: rgba(255,90,90,.35); background: rgba(255,90,90,.08)}
.footerNav{
  position:fixed;
  left:0; right:0; bottom:0;
  background: rgba(0,0,0,.78);
  backdrop-filter: blur(10px);
  border-top:1px solid rgba(255,255,255,.12);
  padding:10px 12px;
}
.footerNav .bar{
  max-width:1100px; margin:0 auto;
  display:flex; gap:10px; justify-content:space-between;
}
.navBtn{
  flex:1;
  padding:10px 10px;
  border-radius:14px;
  background: rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
  color:var(--text);
  font-weight:900;
}
.navBtn.active{ background: rgba(201,162,77,.18); border-color: rgba(201,162,77,.40); }
.hidden{display:none !important}
.notice{
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(201,162,77,.35);
  background: rgba(201,162,77,.08);
  color: var(--text);
}
.locked{
  opacity:.65;
  pointer-events:none;
  filter: grayscale(.25);
}
.lockLabel{
  display:inline-flex; align-items:center; gap:8px;
  margin-left:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.25);
  color: var(--muted);
  font-weight:900;
  font-size:12px;
}
.brandLogo{
  width:42px; height:42px;
  border-radius:14px;
  object-fit:cover;
  border:1px solid rgba(255,255,255,.18);
  background:#111;
}
</style>
</head>

<body>
<div class="container">
  <div class="topbar">
    <div class="brand">
      <div id="brandMark" class="brandMark"></div>
      <img id="brandLogo" class="brandLogo hidden" alt="logo" />
      <div>
        <div class="brandName" id="brandName">HairHaus Pro</div>
        <small id="brandSub">Tha DollHouse™ Salon Suite</small>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end; align-items:center; max-width:520px;">
      <span class="badge" id="planBadge"><span class="dot"></span><span id="planText">trial</span></span>
      <span class="badge" id="roleBadge"><span class="dot"></span><span id="roleText">guest</span></span>
      <button class="ghost" id="btnLogout" onclick="logout()" style="display:none;">Logout</button>
    </div>
  </div>

  <!-- LANDING -->
  <div id="screenLanding" class="grid">
    <div class="card">
      <p class="h1">Luxury salon operations—on autopilot.</p>
      <p style="color:var(--muted); margin-top:8px;">
        Bookings, client memory, deposits, analytics, white-label branding, and photo records—built for hair professionals.
      </p>

      <div class="notice" style="margin-top:12px;">
        <b>Important:</b> If clicking Login ever shows a blank page, it means your keys are missing/invalid.
        This file includes a safe UI + clear errors.
      </div>

      <hr />

      <p class="h2">Login</p>
      <div style="margin-top:10px;">
        <input id="email" placeholder="Email" autocomplete="email" />
        <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
        <div class="row" style="margin-top:10px;">
          <button style="flex:1" onclick="login()">Login</button>
          <button class="dark" style="flex:1" onclick="signup()">Create Account</button>
        </div>
        <small id="authMsg" style="display:block; margin-top:10px;"></small>
      </div>

      <hr />

      <p class="h2">Plans</p>
      <div class="list">
        <div class="item">
          <div class="itemTop">
            <div>
              <div class="itemTitle">Solo</div>
              <div class="itemMeta">Perfect for independent stylists</div>
            </div>
            <span class="pill gold">$29/mo</span>
          </div>
          <div class="row" style="margin-top:10px;">
            <a id="stripeSolo" href="#" style="flex:1"><button style="width:100%">Subscribe</button></a>
            <button class="ghost" style="flex:1" onclick="refreshPlan()">Refresh Plan</button>
          </div>
        </div>

        <div class="item">
          <div class="itemTop">
            <div>
              <div class="itemTitle">Studio</div>
              <div class="itemMeta">Owner analytics + multi-stylist</div>
            </div>
            <span class="pill gold">$99/mo</span>
          </div>
          <div class="row" style="margin-top:10px;">
            <a id="stripeStudio" href="#" style="flex:1"><button style="width:100%">Subscribe</button></a>
            <button class="ghost" style="flex:1" onclick="refreshPlan()">Refresh Plan</button>
          </div>
        </div>

        <div class="item">
          <div class="itemTop">
            <div>
              <div class="itemTitle">White-Label</div>
              <div class="itemMeta">Custom logo + colors + optional branding removal</div>
            </div>
            <span class="pill gold">$399/mo</span>
          </div>
          <div class="row" style="margin-top:10px;">
            <a id="stripeWhiteLabel" href="#" style="flex:1"><button style="width:100%">Subscribe</button></a>
            <button class="ghost" style="flex:1" onclick="refreshPlan()">Refresh Plan</button>
          </div>
          <small style="display:block;margin-top:8px;color:var(--muted)">
            Activation is automatic after Stripe webhook updates your salon plan in Supabase.
          </small>
        </div>
      </div>
    </div>

    <div class="card">
      <p class="h1">What you’re getting</p>
      <div class="list">
        <div class="item"><b>Owner dashboard</b><div class="itemMeta">Revenue, bookings, repeat rate, and performance by stylist</div></div>
        <div class="item"><b>Booking calendar</b><div class="itemMeta">Mobile-first appointments with status + deposit flag</div></div>
        <div class="item"><b>Client memory</b><div class="itemMeta">Notes, formulas, hair type, and photo history per client</div></div>
        <div class="item"><b>White-label</b><div class="itemMeta">Auto-apply salon branding across the app</div></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="screenApp" class="hidden">
    <div class="grid">
      <!-- LEFT PANEL -->
      <div class="card">
        <div class="cardTitle">
          <p class="h2">Quick Actions</p>
          <span class="pill" id="salonPill">No salon</span>
        </div>

        <div class="list">
          <div class="item">
            <div class="itemTitle">Create/Update Salon</div>
            <div class="itemMeta">Owner only — link your account to a salon</div>
            <div class="row" style="margin-top:10px;">
              <input id="salonName" placeholder="Salon name" />
            </div>
            <div class="row" style="margin-top:10px;">
              <button onclick="createOrUpdateSalon()">Save Salon</button>
              <button class="ghost" onclick="refreshAll()">Refresh</button>
            </div>
            <small id="salonMsg" style="display:block; margin-top:8px;"></small>
          </div>

          <div class="item">
            <div class="itemTitle">Add Client</div>
            <div class="row" style="margin-top:10px;">
              <input id="clientName" placeholder="Client name" />
              <input id="clientPhone" placeholder="Phone (optional)" />
            </div>
            <button style="width:100%; margin-top:10px;" onclick="addClient()">Add Client</button>
            <small id="clientMsg" style="display:block; margin-top:8px;"></small>
          </div>

          <div class="item">
            <div class="itemTitle">Add Booking</div>
            <div class="row" style="margin-top:10px;">
              <select id="bkClient"></select>
              <select id="bkStylist"></select>
            </div>
            <div class="row" style="margin-top:10px;">
              <input id="bkService" placeholder="Service (e.g., Silk Press)" />
              <input id="bkTime" type="datetime-local" />
            </div>
            <div class="row" style="margin-top:10px;">
              <select id="bkDeposit">
                <option value="false">Deposit Not Paid</option>
                <option value="true">Deposit Paid</option>
              </select>
              <select id="bkStatus">
                <option value="scheduled">Scheduled</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
                <option value="no_show">No-Show</option>
              </select>
            </div>
            <button style="width:100%; margin-top:10px;" onclick="addBooking()">Add Booking</button>
            <small id="bookingMsg" style="display:block; margin-top:8px;"></small>
          </div>
        </div>
      </div>

      <!-- RIGHT PANEL -->
      <div class="card">
        <div class="cardTitle">
          <p class="h1" id="screenTitle">Dashboard</p>
          <div class="row" style="max-width:420px; justify-content:flex-end;">
            <button class="ghost" onclick="refreshAll()">Refresh Data</button>
            <button class="danger" onclick="logout()">Logout</button>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" id="tabDash" onclick="setTab('dash')">Dashboard</div>
          <div class="tab" id="tabBookings" onclick="setTab('bookings')">Bookings</div>
          <div class="tab" id="tabClients" onclick="setTab('clients')">Clients</div>
          <div class="tab" id="tabPhotos" onclick="setTab('photos')">Photos</div>
          <div class="tab" id="tabBrand" onclick="setTab('brand')">Branding</div>
        </div>

        <!-- DASH -->
        <div id="viewDash" style="margin-top:12px;">
          <div class="kpis">
            <div class="kpi"><div class="n" id="kRevenue">$0</div><div class="l">Est. Revenue (month)</div></div>
            <div class="kpi"><div class="n" id="kBookings">0</div><div class="l">Bookings (30d)</div></div>
            <div class="kpi"><div class="n" id="kRepeat">0%</div><div class="l">Repeat rate</div></div>
            <div class="kpi"><div class="n" id="kNoShow">$0</div><div class="l">No-show loss (est.)</div></div>
          </div>

          <div class="notice" style="margin-top:12px;">
            <b>Owner vs Stylist:</b> Stylists see only their bookings + client notes. Owners see full salon analytics.
          </div>

          <div class="list">
            <div class="item">
              <div class="itemTop">
                <div>
                  <div class="itemTitle">Plan Activation</div>
                  <div class="itemMeta">If you just paid in Stripe, press Refresh Plan.</div>
                </div>
                <span class="pill gold" id="pillPlan">trial</span>
              </div>
              <div class="row" style="margin-top:10px;">
                <button class="ghost" onclick="refreshPlan()">Refresh Plan</button>
                <button class="dark" onclick="openPricing()">Open Pricing</button>
              </div>
              <small id="planMsg" style="display:block; margin-top:8px;"></small>
            </div>

            <div class="item" id="ownerOnlyBox">
              <div class="itemTitle">Owner Analytics (Live)</div>
              <div class="itemMeta">Total bookings + performance summary by stylist.</div>
              <div class="list" id="stylistPerf"></div>
            </div>
          </div>
        </div>

        <!-- BOOKINGS -->
        <div id="viewBookings" class="hidden" style="margin-top:12px;">
          <div class="notice">Calendar view: mobile-first list (sorted by time). Swipe-style controls are next phase.</div>
          <div class="list" id="bookingsList"></div>
        </div>

        <!-- CLIENTS -->
        <div id="viewClients" class="hidden" style="margin-top:12px;">
          <div class="list" id="clientsList"></div>
        </div>

        <!-- PHOTOS -->
        <div id="viewPhotos" class="hidden" style="margin-top:12px;">
          <div id="photoLockedNotice" class="notice hidden">
            Photo uploads require <b>Studio</b> or higher.
          </div>
          <div class="item" id="photoUploader">
            <div class="itemTitle">Upload Client Photo</div>
            <div class="itemMeta">Stored in Supabase Storage bucket: <b>client-photos</b></div>
            <div class="row" style="margin-top:10px;">
              <select id="phClient"></select>
            </div>
            <div class="row" style="margin-top:10px;">
              <input id="phFile" type="file" accept="image/*" />
            </div>
            <div class="row" style="margin-top:10px;">
              <textarea id="phNotes" placeholder="Notes (formula, hair type, etc.)"></textarea>
            </div>
            <button style="width:100%; margin-top:10px;" onclick="uploadPhoto()">Upload Photo</button>
            <small id="photoMsg" style="display:block; margin-top:8px;"></small>
          </div>

          <div class="list" id="photosList"></div>
        </div>

        <!-- BRANDING -->
        <div id="viewBrand" class="hidden" style="margin-top:12px;">
          <div class="item">
            <div class="itemTop">
              <div>
                <div class="itemTitle">White-Label Branding</div>
                <div class="itemMeta">Auto-applies salon title, gold color, and logo across the app.</div>
              </div>
              <span class="pill" id="wlPill">Locked</span>
            </div>

            <div id="wlLocked" class="notice" style="margin-top:10px;">
              White-Label is locked on your current plan.
              <b>Upgrade to White-Label</b> to unlock logo + brand controls.
            </div>

            <div id="wlControls" class="hidden" style="margin-top:10px;">
              <div class="row">
                <input id="brandColor" placeholder="Brand color hex (e.g. #C9A24D)" />
                <input id="logoUrl" placeholder="Logo URL (optional)" />
              </div>
              <div class="row" style="margin-top:10px;">
                <button onclick="saveBranding()">Save Branding</button>
                <button class="ghost" onclick="applyBranding()">Apply Now</button>
              </div>
              <small id="brandMsg" style="display:block; margin-top:8px;"></small>
            </div>
          </div>

          <div class="notice" style="margin-top:12px;">
            <b>How auto-branding works:</b> We read your salon record in Supabase (<code>salons.brand_color</code>, <code>salons.logo_url</code>, <code>salons.white_label</code>)
            and apply the theme instantly after login.
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<div class="footerNav hidden" id="footerNav">
  <div class="bar">
    <button class="navBtn active" id="navDash" onclick="setTab('dash')">Dashboard</button>
    <button class="navBtn" id="navBookings" onclick="setTab('bookings')">Bookings</button>
    <button class="navBtn" id="navClients" onclick="setTab('clients')">Clients</button>
    <button class="navBtn" id="navPhotos" onclick="setTab('photos')">Photos</button>
    <button class="navBtn" id="navBrand" onclick="setTab('brand')">Brand</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* =========================
   1) PASTE YOUR SUPABASE KEYS
   ========================= */
const SUPABASE_URL = "https://fjjedjoakplopglfkjsn.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqamVkam9ha3Bsb3BnbGZranNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MTQzNjAsImV4cCI6MjA4NTI5MDM2MH0.svOkXz6Y3ZSLd75q11N83Zaj6ClUV9ZVHvSkI9JKzYc";
const supabase = (SUPABASE_URL.startsWith("http") && SUPABASE_ANON_KEY.length > 20)
  ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
  : null;

/* =========================
   2) OPTIONAL: STRIPE CHECKOUT LINKS
   Replace with your real Stripe Payment Links
   ========================= */
const STRIPE_LINKS = {
  solo: "PASTE_STRIPE_PAYMENT_LINK_SOLO",
  studio: "PASTE_STRIPE_PAYMENT_LINK_STUDIO",
  whitelabel: "PASTE_STRIPE_PAYMENT_LINK_WHITELABEL"
};
document.getElementById("stripeSolo").href = STRIPE_LINKS.solo || "#";
document.getElementById("stripeStudio").href = STRIPE_LINKS.studio || "#";
document.getElementById("stripeWhiteLabel").href = STRIPE_LINKS.whitelabel || "#";

/* =========================
   App State
   ========================= */
let user = null;
let profile = null; // profiles table: role, salon_id
let salon = null;   // salons table: plan, white_label, brand_color, logo_url
let clients = [];
let stylists = [];
let bookings = [];
let photos = [];

const screens = {
  landing: document.getElementById("screenLanding"),
  app: document.getElementById("screenApp")
};

function setBadge(elText, elBadge, text, type="gold"){
  elText.textContent = text;
  const dot = elBadge.querySelector(".dot");
  dot.className = "dot";
  if(type==="ok") dot.classList.add("ok");
  if(type==="danger") dot.classList.add("danger");
}

function showMsg(id, msg, isErr=false){
  const el = document.getElementById(id);
  if(!el) return;
  el.style.color = isErr ? "var(--danger)" : "var(--muted)";
  el.textContent = msg || "";
}

function mustBeConnected(){
  if(!supabase){
    showMsg("authMsg", "Supabase keys are not set in index.html yet. Paste SUPABASE_URL + ANON_KEY and refresh.", true);
    return false;
  }
  return true;
}

/* =========================
   Auth
   ========================= */
window.login = async function(){
  if(!mustBeConnected()) return;

  showMsg("authMsg","Signing in...");
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){ showMsg("authMsg", error.message, true); return; }

  user = data.user;
  await boot();
};

window.signup = async function(){
  if(!mustBeConnected()) return;

  showMsg("authMsg","Creating account...");
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signUp({ email, password });
  if(error){ showMsg("authMsg", error.message, true); return; }

  showMsg("authMsg", "Account created. Now log in. (If email confirmations are enabled, check inbox.)");
};

window.logout = async function(){
  if(supabase) await supabase.auth.signOut();
  user = null; profile = null; salon = null;
  screens.app.classList.add("hidden");
  screens.landing.classList.remove("hidden");
  document.getElementById("footerNav").classList.add("hidden");
  document.getElementById("btnLogout").style.display="none";
  setBadge(document.getElementById("roleText"), document.getElementById("roleBadge"), "guest");
  setBadge(document.getElementById("planText"), document.getElementById("planBadge"), "trial");
};

async function getSessionUser(){
  if(!supabase) return null;
  const { data } = await supabase.auth.getUser();
  return data?.user || null;
}

/* =========================
   Boot / Load data
   ========================= */
async function boot(){
  if(!mustBeConnected()) return;

  // Ensure we have user
  if(!user) user = await getSessionUser();
  if(!user) return;

  // Load profile
  const p = await supabase.from("profiles").select("*").eq("id", user.id).maybeSingle();
  if(p.error){
    showMsg("authMsg", "Profile missing. Create a row in profiles table for this user (id=user UUID, role owner/stylist).", true);
    return;
  }
  profile = p.data;

  // If profile missing, block
  if(!profile){
    showMsg("authMsg", "Profile not found. Add row in profiles table for this user UUID.", true);
    return;
  }

  // Load salon if linked
  salon = null;
  if(profile.salon_id){
    const s = await supabase.from("salons").select("*").eq("id", profile.salon_id).maybeSingle();
    salon = s.data || null;
  }

  // UI: switch screens
  screens.landing.classList.add("hidden");
  screens.app.classList.remove("hidden");
  document.getElementById("footerNav").classList.remove("hidden");
  document.getElementById("btnLogout").style.display="inline-flex";

  // Badges
  setBadge(document.getElementById("roleText"), document.getElementById("roleBadge"), profile.role || "unknown", "ok");
  const planVal = salon?.plan || "trial";
  setBadge(document.getElementById("planText"), document.getElementById("planBadge"), planVal, planVal==="trial" ? "gold" : "ok");
  document.getElementById("pillPlan").textContent = planVal;

  // Salon pill
  document.getElementById("salonPill").textContent = salon?.name ? salon.name : "No salon linked";

  // Owner-only box
  document.getElementById("ownerOnlyBox").classList.toggle("hidden", profile.role !== "owner");

  // Pre-fill salon name input
  document.getElementById("salonName").value = salon?.name || "";

  // Apply branding (white-label)
  applyBranding();

  // Load data lists
  await refreshAll();

  // Default tab
  setTab("dash");
}

window.refreshAll = async function(){
  if(!mustBeConnected()) return;
  if(!profile?.salon_id){ 
    showMsg("salonMsg", "Create a salon (Owner) then link your profile.salon_id.", true);
    return;
  }

  // For owner: load everything; for stylist: limit views later
  await Promise.all([loadClients(), loadStylists(), loadBookings(), loadPhotos()]);
  populateSelectors();
  renderAll();
};

async function loadClients(){
  const res = await supabase.from("clients").select("*").eq("salon_id", profile.salon_id).order("name");
  clients = res.data || [];
}
async function loadStylists(){
  // Stylists table is optional; allow fallback with current user as stylist
  const res = await supabase.from("stylists").select("*").eq("salon_id", profile.salon_id).order("name");
  stylists = res.data || [];

  // Ensure at least one stylist exists for bookings dropdown (esp. stylist role)
  if(stylists.length === 0){
    // create a default stylist record (owner only creates automatically)
    if(profile.role === "owner"){
      await supabase.from("stylists").insert([{ salon_id: profile.salon_id, name: "Primary Stylist", commission: 0.5 }]);
      const res2 = await supabase.from("stylists").select("*").eq("salon_id", profile.salon_id).order("name");
      stylists = res2.data || [];
    }
  }
}
async function loadBookings(){
  // Owner: all salon bookings. Stylist: all bookings for their salon too (you can tighten to stylist_id later).
  const res = await supabase
    .from("bookings")
    .select("*, clients(name), stylists(name)")
    .eq("salon_id", profile.salon_id)
    .order("appointment_time", { ascending: true });

  bookings = res.data || [];

  // If stylist role and you want strict: filter here by stylist_id (requires mapping user->stylist)
  // bookings = (profile.role==="stylist") ? bookings.filter(b=>b.stylist_id===YOUR_STYLIST_ID) : bookings;
}
async function loadPhotos(){
  // Photos list: join to clients for name
  // client_photos table: client_id, image_url, notes
  // This loads all; you can filter by stylist ownership later if desired.
  const res = await supabase
    .from("client_photos")
    .select("*, clients(name)")
    .order("created_at", { ascending: false });
  photos = res.data || [];
}

/* =========================
   Create Salon / Link Profile (Owner)
   ========================= */
window.createOrUpdateSalon = async function(){
  if(!mustBeConnected()) return;
  if(profile.role !== "owner"){
    showMsg("salonMsg","Only owners can create/update salon.", true);
    return;
  }

  const name = document.getElementById("salonName").value.trim();
  if(!name){ showMsg("salonMsg","Enter a salon name.", true); return; }

  showMsg("salonMsg","Saving salon...");
  // If user already has a salon linked, update. Otherwise create + link.
  if(profile.salon_id){
    const up = await supabase.from("salons").update({ name }).eq("id", profile.salon_id).select().maybeSingle();
    if(up.error){ showMsg("salonMsg", up.error.message, true); return; }
    salon = up.data;
  }else{
    const ins = await supabase.from("salons").insert([{
      name, plan:"trial", white_label:false, brand_color:"#C9A24D", owner_id:user.id
    }]).select().maybeSingle();
    if(ins.error){ showMsg("salonMsg", ins.error.message, true); return; }
    salon = ins.data;

    const link = await supabase.from("profiles").update({ salon_id: salon.id }).eq("id", user.id);
    if(link.error){ showMsg("salonMsg", link.error.message, true); return; }
    profile.salon_id = salon.id;
  }

  document.getElementById("salonPill").textContent = salon.name;
  showMsg("salonMsg","Salon saved. Refreshing…");
  await boot();
};

/* =========================
   Clients / Bookings
   ========================= */
window.addClient = async function(){
  if(!mustBeConnected()) return;
  if(!profile?.salon_id){ showMsg("clientMsg","Create/link a salon first.", true); return; }

  const name = document.getElementById("clientName").value.trim();
  const phone = document.getElementById("clientPhone").value.trim();
  if(!name){ showMsg("clientMsg","Client name required.", true); return; }

  showMsg("clientMsg","Adding client...");
  const ins = await supabase.from("clients").insert([{ salon_id: profile.salon_id, name, phone }]);
  if(ins.error){ showMsg("clientMsg", ins.error.message, true); return; }
  document.getElementById("clientName").value="";
  document.getElementById("clientPhone").value="";
  await loadClients();
  populateSelectors();
  renderClients();
  showMsg("clientMsg","Client added.");
};

window.addBooking = async function(){
  if(!mustBeConnected()) return;
  if(!profile?.salon_id){ showMsg("bookingMsg","Create/link a salon first.", true); return; }

  const client_id = document.getElementById("bkClient").value;
  const stylist_id = document.getElementById("bkStylist").value;
  const service = document.getElementById("bkService").value.trim();
  const appointment_time = document.getElementById("bkTime").value;
  const deposit_paid = document.getElementById("bkDeposit").value === "true";
  const status = document.getElementById("bkStatus").value;

  if(!client_id || !stylist_id || !service || !appointment_time){
    showMsg("bookingMsg","Select client, stylist, time, and service.", true); return;
  }

  showMsg("bookingMsg","Adding booking...");
  const ins = await supabase.from("bookings").insert([{
    salon_id: profile.salon_id, client_id, stylist_id, service,
    appointment_time: new Date(appointment_time).toISOString(),
    deposit_paid, status
  }]);

  if(ins.error){ showMsg("bookingMsg", ins.error.message, true); return; }
  document.getElementById("bkService").value="";
  await loadBookings();
  renderBookings();
  showMsg("bookingMsg","Booking added.");
};

async function updateBookingStatus(id, status){
  const up = await supabase.from("bookings").update({ status }).eq("id", id);
  if(up.error){ alert(up.error.message); return; }
  await loadBookings();
  renderBookings();
}

/* =========================
   Photo Upload (Storage + table)
   Requires Storage bucket: client-photos
   ========================= */
function planAllowsPhotos(){
  const p = (salon?.plan || "trial").toLowerCase();
  return (p === "studio" || p === "whitelabel" || p === "elite" || p === "pro");
}
window.uploadPhoto = async function(){
  if(!mustBeConnected()) return;
  if(!profile?.salon_id){ showMsg("photoMsg","Create/link a salon first.", true); return; }
  if(!planAllowsPhotos()){
    showMsg("photoMsg","Photo uploads are locked. Upgrade to Studio or higher.", true);
    return;
  }

  const client_id = document.getElementById("phClient").value;
  const fileInput = document.getElementById("phFile");
  const notes = document.getElementById("phNotes").value.trim();
  const file = fileInput.files?.[0];
  if(!client_id || !file){ showMsg("photoMsg","Select a client and choose an image.", true); return; }

  showMsg("photoMsg","Uploading...");
  const ext = (file.name.split(".").pop() || "jpg").toLowerCase();
  const path = `${profile.salon_id}/${client_id}/${crypto.randomUUID()}.${ext}`;

  const up = await supabase.storage.from("client-photos").upload(path, file, { upsert:false });
  if(up.error){ showMsg("photoMsg", up.error.message, true); return; }

  // Get a signed URL (private bucket recommended)
  const signed = await supabase.storage.from("client-photos").createSignedUrl(path, 60 * 60 * 24 * 7);
  if(signed.error){ showMsg("photoMsg", signed.error.message, true); return; }

  const ins = await supabase.from("client_photos").insert([{
    client_id,
    image_url: signed.data.signedUrl,
    notes
  }]);
  if(ins.error){ showMsg("photoMsg", ins.error.message, true); return; }

  document.getElementById("phNotes").value="";
  fileInput.value="";
  await loadPhotos();
  renderPhotos();
  showMsg("photoMsg","Uploaded.");
};

/* =========================
   White-Label Branding
   White-label is enabled when salon.white_label = true
   ========================= */
function isWhiteLabel(){
  return !!salon?.white_label;
}
window.applyBranding = function(){
  // Always apply base name
  document.getElementById("brandName").textContent = isWhiteLabel() ? (salon?.name || "Salon") : "HairHaus Pro";
  document.getElementById("brandSub").textContent = isWhiteLabel() ? "Salon Suite" : "Tha DollHouse™ Salon Suite";

  // Color
  const color = (isWhiteLabel() && salon?.brand_color) ? salon.brand_color : "#C9A24D";
  document.documentElement.style.setProperty("--gold", color);

  // Logo
  const logoEl = document.getElementById("brandLogo");
  const markEl = document.getElementById("brandMark");
  if(isWhiteLabel() && salon?.logo_url){
    logoEl.src = salon.logo_url;
    logoEl.classList.remove("hidden");
    markEl.classList.add("hidden");
    document.title = salon.name || "Salon Suite";
  }else{
    logoEl.classList.add("hidden");
    markEl.classList.remove("hidden");
    document.title = "HairHaus Pro | Tha DollHouse";
  }

  // Branding tab controls
  const wl = document.getElementById("wlPill");
  const wlLocked = document.getElementById("wlLocked");
  const wlControls = document.getElementById("wlControls");

  if(isWhiteLabel()){
    wl.textContent = "Enabled";
    wl.className = "pill ok";
    wlLocked.classList.add("hidden");
    wlControls.classList.remove("hidden");
    document.getElementById("brandColor").value = salon?.brand_color || "#C9A24D";
    document.getElementById("logoUrl").value = salon?.logo_url || "";
  }else{
    wl.textContent = "Locked";
    wl.className = "pill";
    wlLocked.classList.remove("hidden");
    wlControls.classList.add("hidden");
  }

  // Photos lock UI
  const photoLockedNotice = document.getElementById("photoLockedNotice");
  const photoUploader = document.getElementById("photoUploader");
  if(planAllowsPhotos()){
    photoLockedNotice.classList.add("hidden");
    photoUploader.classList.remove("locked");
  }else{
    photoLockedNotice.classList.remove("hidden");
    photoUploader.classList.add("locked");
  }
};

window.saveBranding = async function(){
  if(profile.role !== "owner"){ showMsg("brandMsg","Owner only.", true); return; }
  if(!isWhiteLabel()){ showMsg("brandMsg","White-Label locked.", true); return; }

  const brand_color = document.getElementById("brandColor").value.trim() || "#C9A24D";
  const logo_url = document.getElementById("logoUrl").value.trim() || null;

  const up = await supabase.from("salons").update({ brand_color, logo_url }).eq("id", salon.id).select().maybeSingle();
  if(up.error){ showMsg("brandMsg", up.error.message, true); return; }
  salon = up.data;
  applyBranding();
  showMsg("brandMsg","Branding saved.");
};

/* =========================
   Stripe Plan Activation (Frontend safe)
   IMPORTANT: Real activation requires webhook/Edge Function to set salons.plan & salons.white_label.
   This button just reloads salon record.
   ========================= */
window.refreshPlan = async function(){
  if(!mustBeConnected()) return;
  if(!profile?.salon_id){ showMsg("planMsg","No salon linked yet.", true); return; }

  showMsg("planMsg","Refreshing plan...");
  const s = await supabase.from("salons").select("*").eq("id", profile.salon_id).maybeSingle();
  if(s.error){ showMsg("planMsg", s.error.message, true); return; }
  salon = s.data;

  const planVal = salon?.plan || "trial";
  document.getElementById("pillPlan").textContent = planVal;
  setBadge(document.getElementById("planText"), document.getElementById("planBadge"), planVal, planVal==="trial" ? "gold" : "ok");
  document.getElementById("planMsg").textContent =
    "If you paid in Stripe and this still says trial, your webhook/Edge Function hasn’t updated Supabase yet.";

  applyBranding();
  renderAll();
};

window.openPricing = function(){
  screens.app.classList.add("hidden");
  screens.landing.classList.remove("hidden");
  document.getElementById("footerNav").classList.add("hidden");
  window.scrollTo({top:0, behavior:"smooth"});
};

/* =========================
   UI: Tabs
   ========================= */
window.setTab = function(tab){
  // tabs
  for(const t of ["dash","bookings","clients","photos","brand"]){
    document.getElementById("tab"+cap(t)).classList.toggle("active", t===tab);
    document.getElementById("nav"+cap(t)).classList.toggle("active", t===tab);
  }
  // views
  document.getElementById("viewDash").classList.toggle("hidden", tab!=="dash");
  document.getElementById("viewBookings").classList.toggle("hidden", tab!=="bookings");
  document.getElementById("viewClients").classList.toggle("hidden", tab!=="clients");
  document.getElementById("viewPhotos").classList.toggle("hidden", tab!=="photos");
  document.getElementById("viewBrand").classList.toggle("hidden", tab!=="brand");

  document.getElementById("screenTitle").textContent =
    tab==="dash" ? "Dashboard" :
    tab==="bookings" ? "Bookings" :
    tab==="clients" ? "Clients" :
    tab==="photos" ? "Photos" : "Branding";
};

function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

/* =========================
   Render
   ========================= */
function populateSelectors(){
  const bkClient = document.getElementById("bkClient");
  const bkStylist = document.getElementById("bkStylist");
  const phClient = document.getElementById("phClient");

  bkClient.innerHTML = `<option value="">Select client</option>` + clients.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
  phClient.innerHTML = `<option value="">Select client</option>` + clients.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");

  bkStylist.innerHTML = `<option value="">Select stylist</option>` + stylists.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
}

function renderAll(){
  // KPIs
  renderKpis();
  renderBookings();
  renderClients();
  renderPhotos();
  renderStylistPerf();
}

function renderKpis(){
  // Simple KPI estimates (you can refine with pricing per service later)
  const now = new Date();
  const days30 = new Date(now.getTime() - 30*24*3600*1000);

  const last30 = bookings.filter(b=> b.appointment_time && new Date(b.appointment_time) >= days30);
  const completed = last30.filter(b=> b.status === "completed").length;
  const noShow = last30.filter(b=> b.status === "no_show").length;

  // Revenue estimate: assume $90 per completed booking (edit this)
  const estRev = completed * 90;
  const estNoShowLoss = noShow * 50;

  document.getElementById("kRevenue").textContent = `$${estRev.toLocaleString()}`;
  document.getElementById("kBookings").textContent = `${last30.length}`;

  // Repeat estimate: repeat if client appears 2+ times in last30
  const counts = {};
  last30.forEach(b=>{ counts[b.client_id] = (counts[b.client_id]||0)+1; });
  const repeatClients = Object.values(counts).filter(n=>n>=2).length;
  const totalClients = Object.keys(counts).length || 1;
  const repeatRate = Math.round((repeatClients/totalClients)*100);
  document.getElementById("kRepeat").textContent = `${repeatRate}%`;

  document.getElementById("kNoShow").textContent = `$${estNoShowLoss.toLocaleString()}`;
}

function renderBookings(){
  const list = document.getElementById("bookingsList");
  const role = profile?.role || "guest";

  // If stylist: show bookings (optionally filtered)
  const visible = bookings; // tighten later to stylist_id mapping
  list.innerHTML = visible.length ? "" : `<div class="item">No bookings yet.</div>`;

  visible.forEach(b=>{
    const clientName = b.clients?.name || "Client";
    const stylistName = b.stylists?.name || "Stylist";
    const when = b.appointment_time ? new Date(b.appointment_time) : null;
    const dt = when ? when.toLocaleString() : "No time";

    const depPill = b.deposit_paid ? `<span class="pill ok"><span class="dot ok"></span>Deposit</span>` : `<span class="pill"><span class="dot"></span>No deposit</span>`;
    const statusPill =
      b.status === "completed" ? `<span class="pill ok">Completed</span>` :
      b.status === "cancelled" ? `<span class="pill danger">Cancelled</span>` :
      b.status === "no_show" ? `<span class="pill danger">No-Show</span>` :
      `<span class="pill gold">Scheduled</span>`;

    const controls = (role==="owner") ? `
      <div class="row" style="margin-top:10px;">
        <button class="dark" onclick="__setStatus('${b.id}','completed')">Complete</button>
        <button class="ghost" onclick="__setStatus('${b.id}','cancelled')">Cancel</button>
        <button class="danger" onclick="__setStatus('${b.id}','no_show')">No-Show</button>
      </div>
    ` : ``;

    const div = document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(clientName)} — ${escapeHtml(b.service || "Service")}</div>
          <div class="itemMeta">${escapeHtml(dt)} • Stylist: ${escapeHtml(stylistName)}</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          ${depPill}
          ${statusPill}
        </div>
      </div>
      ${controls}
    `;
    list.appendChild(div);
  });
}
window.__setStatus = async (id, status)=> updateBookingStatus(id, status);

function renderClients(){
  const list = document.getElementById("clientsList");
  list.innerHTML = clients.length ? "" : `<div class="item">No clients yet.</div>`;

  clients.forEach(c=>{
    const div = document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(c.name)}</div>
          <div class="itemMeta">${escapeHtml(c.phone || "No phone")} • Loyalty: ${c.loyalty_points || 0}</div>
        </div>
        <span class="pill">Client</span>
      </div>
    `;
    list.appendChild(div);
  });
}

function renderPhotos(){
  const list = document.getElementById("photosList");
  // Show only if plan allows or display locked note
  if(!planAllowsPhotos()){
    list.innerHTML = `<div class="item">Upgrade to Studio to view photo history here.</div>`;
    return;
  }

  list.innerHTML = photos.length ? "" : `<div class="item">No photos yet.</div>`;
  photos.forEach(p=>{
    const cname = p.clients?.name || "Client";
    const div = document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(cname)}</div>
          <div class="itemMeta">${escapeHtml(new Date(p.created_at).toLocaleString())}</div>
        </div>
        <span class="pill ok"><span class="dot ok"></span>Photo</span>
      </div>
      <div style="margin-top:10px;">
        <img src="${escapeAttr(p.image_url)}" alt="photo" style="width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.12)" />
      </div>
      ${p.notes ? `<div class="itemMeta" style="margin-top:10px;"><b>Notes:</b> ${escapeHtml(p.notes)}</div>` : ""}
    `;
    list.appendChild(div);
  });
}

function renderStylistPerf(){
  const box = document.getElementById("stylistPerf");
  if(profile?.role !== "owner"){ box.innerHTML=""; return; }
  if(!stylists.length){
    box.innerHTML = `<div class="item">No stylists yet.</div>`;
    return;
  }
  // Simple counts per stylist in last 30d
  const now = new Date();
  const days30 = new Date(now.getTime() - 30*24*3600*1000);
  const last30 = bookings.filter(b=> b.appointment_time && new Date(b.appointment_time) >= days30);

  const map = {};
  stylists.forEach(s=> map[s.id] = { name:s.name, total:0, completed:0, no_show:0 });
  last30.forEach(b=>{
    if(map[b.stylist_id]){
      map[b.stylist_id].total++;
      if(b.status==="completed") map[b.stylist_id].completed++;
      if(b.status==="no_show") map[b.stylist_id].no_show++;
    }
  });

  box.innerHTML="";
  Object.values(map).forEach(s=>{
    const div = document.createElement("div");
    div.className="item";
    div.innerHTML = `
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(s.name)}</div>
          <div class="itemMeta">Bookings: ${s.total} • Completed: ${s.completed} • No-Shows: ${s.no_show}</div>
        </div>
        <span class="pill gold">30d</span>
      </div>
    `;
    box.appendChild(div);
  });
}

/* =========================
   Helpers
   ========================= */
function escapeHtml(str){ return (str ?? "").toString().replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
function escapeAttr(str){ return escapeHtml(str).replace(/"/g,"&quot;"); }

/* =========================
   Auto-boot if already logged in
   ========================= */
(async ()=>{
  if(!supabase){
    showMsg("authMsg","Paste your Supabase URL + Anon key inside this index.html, then refresh.", true);
    return;
  }
  user = await getSessionUser();
  if(user) await boot();
})();
</script>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js").catch(()=>{});
}
</script>
</body>
</html>
